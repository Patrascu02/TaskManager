@model IEnumerable<TaskManager.Modules.Tasks.Models.UserTask>

@{
    ViewData["Title"] = "GESTIUNE SARCINI";
    Layout = "~/Modules/Views/Shared/_Layout.cshtml";
}

<div class="fade-in pt-4">

    <header class="hud-header-panel mb-4 mt-4">
        <div>
            <h2 class="hud-welcome">SARCINI</h2>
            <small>GESTIONEAZĂ LISTA DE TASK-URI ȘI PRIORITĂȚI</small>
        </div>
        <a asp-action="Create" class="btn-tech text-decoration-none">
            <i class="bi bi-plus-lg me-2"></i> SARCINĂ NOUĂ
        </a>
    </header>

    <div class="cyber-table-card">

        <div class="p-3 border-bottom border-secondary" style="background: rgba(0,0,0,0.2);">
            <div class="input-group" style="max-width: 350px;">
                <span class="input-group-text border-secondary bg-dark text-info">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="searchTask" class="form-control bg-dark text-light border-secondary font-monospace" placeholder="CAUTĂ SARCINĂ...">
            </div>
        </div>

        <div class="table-responsive">
            <table class="cyber-table align-middle mb-0">
                <thead>
                    <tr>
                        <th class="ps-4">TITLU & DESCRIERE</th>
                        <th class="text-center">PRIORITATE</th>
                        <th class="text-center">TERMEN LIMITĂ</th>
                        <th class="pe-4 text-end">ACȚIUNI</th>
                    </tr>
                </thead>
                <tbody id="taskTableBody">
                    @foreach (var item in Model)
                    {
                        // Logică vizuală pentru dată și prioritate
                        bool isOverdue = item.DueDate.HasValue && item.DueDate.Value < DateTime.Now;
                        string dateColor = isOverdue ? "text-danger fw-bold" : "text-info";

                        string priorityClass = "";
                        string priorityLabel = "";

                        if (item.Priority == 1) { priorityClass = "border-danger text-danger"; priorityLabel = "CRITIC"; }
                        else if (item.Priority == 2) { priorityClass = "border-warning text-warning"; priorityLabel = "MEDIU"; }
                        else { priorityClass = "border-success text-success"; priorityLabel = "NORMAL"; }

                        <tr>
                            <td class="ps-4" style="max-width: 300px;">
                                <div class="fw-bold text-white mb-1">@item.Title</div>
                                <div class="text-white-50 small text-truncate" style="font-size: 0.85rem;">
                                    @item.Description
                                </div>
                            </td>

                            <td class="text-center">
                                <span class="badge border @priorityClass bg-transparent font-monospace px-3 py-2">
                                    @priorityLabel
                                </span>
                            </td>

                            <td class="text-center font-monospace @dateColor">
                                @if (item.DueDate.HasValue)
                                {
                                    <span><i class="bi bi-calendar-event me-1"></i> @item.DueDate.Value.ToString("dd.MM.yyyy")</span>
                                    if (isOverdue)
                                    {

                                        <div class="small text-danger mt-1">!! EXPIRAT !!</div>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>

                            <td class="pe-4 text-end">
                                <div class="btn-group">
                                    <a asp-action="Edit" asp-route-id="@item.TaskId" class="btn btn-sm btn-outline-info me-2 rounded-0" title="Editează">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a asp-action="Details" asp-route-id="@item.TaskId" class="btn btn-sm btn-outline-warning me-2 rounded-0" title="Detalii">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger rounded-0"
                                            onclick="confirmDelete('@item.TaskId', '@item.Title')"
                                            title="Șterge">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!Model.Any())
        {
            <div class="text-center py-5">
                <div class="text-secondary mb-3"><i class="bi bi-clipboard-x fa-3x"></i></div>
                <h6 class="text-secondary font-monospace">NU EXISTĂ SARCINI ÎN LISTĂ.</h6>
            </div>
        }
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #1e293b; border: 1px solid var(--hud-border); color: #e2e8f0;">
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <div class="d-inline-flex align-items-center justify-content-center"
                         style="width: 80px; height: 80px; background: rgba(244, 63, 94, 0.1); border-radius: 50%; border: 1px solid #f43f5e;">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger"></i>
                    </div>
                </div>

                <h4 class="fw-bold text-white mb-2 font-monospace">EȘTI SIGUR?</h4>

                <p class="text-white-50 mb-4">
                    Ești pe cale să ștergi sarcina: <br>
                    <strong id="deleteTaskTitle" class="text-info fs-5"></strong><br>
                    <span class="small text-danger">Această acțiune este ireversibilă.</span>
                </p>

                <div class="d-flex justify-content-center gap-2">
                    <button type="button" class="btn btn-outline-light px-4 font-monospace" data-bs-dismiss="modal">
                        ANULEAZĂ
                    </button>

                    <form id="deleteForm" method="post">
                        <button type="submit" class="btn btn-danger px-4 fw-bold font-monospace">
                            DA, ȘTERGE
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Căutare Live
        document.getElementById('searchTask').addEventListener('keyup', function() {
            var value = this.value.toLowerCase();
            var rows = document.querySelectorAll("#taskTableBody tr");

            rows.forEach(function(row) {
                var text = row.innerText.toLowerCase();
                row.style.display = text.indexOf(value) > -1 ? "" : "none";
            });
        });

        // --- FIX PENTRU MODAL BLOCAT (Același cod ca la Users) ---
        var deleteModalElement = document.getElementById('deleteModal');
        var deleteModalInstance = null;

        function confirmDelete(taskId, taskTitle) {
            document.getElementById('deleteTaskTitle').textContent = taskTitle;
            var form = document.getElementById('deleteForm');

            // Ruta pentru Tasks Controller Delete
            form.action = '/Tasks/Delete/' + taskId;

            if (!deleteModalInstance) {
                deleteModalInstance = new bootstrap.Modal(deleteModalElement);
            }
            deleteModalInstance.show();
        }

        // Curățare forțată a backdrop-ului la închidere
        deleteModalElement.addEventListener('hidden.bs.modal', function () {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style = '';
        });
    </script>
}