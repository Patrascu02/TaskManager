@model IEnumerable<TaskManager.Modules.Tasks.Models.UserTask>

@{
    ViewData["Title"] = "Task Manager";
    Layout = "~/Modules/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid fade-in mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4 p-3 rounded" style="background: rgba(0, 0, 0, 0.4); border-left: 4px solid #0dcaf0;">
        <div>
            <h2 class="text-white font-monospace mb-0"><i class="bi bi-grid-3x3-gap-fill me-2 text-info"></i>MANAGER CONSOLE</h2>
            <small class="text-white-50 ms-1">Gestionează sarcinile echipei</small>
        </div>
        <a asp-action="Assign" class="btn btn-info fw-bold font-monospace shadow-sm">
            <i class="bi bi-plus-lg me-1"></i> SARCINĂ NOUĂ
        </a>
    </div>

    <div class="card border-0 shadow-lg" style="background: #1e1e24;">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle mb-0" style="border-collapse: separate; border-spacing: 0;">
                    <thead class="bg-dark text-info font-monospace text-uppercase small">
                        <tr>
                            <th class="py-3 ps-4">Sarcina</th>
                            <th class="py-3">Prioritate</th>
                            <th class="py-3">Status Global</th>
                            <th class="py-3">Echipa & Progres</th>
                            <th class="py-3">Termen / Timer</th>
                            <th class="py-3 text-end pe-4">Acțiuni</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            // Calculăm dacă e expirat
                            bool isOverdue = item.DueDate.HasValue && item.DueDate.Value < DateTime.Now && item.IsActive;
                            string rowClass = !item.IsActive ? "opacity-50" : ""; // Îl facem puțin transparent dacă e gata

                            <tr class="@rowClass border-bottom border-secondary">

                                <td class="ps-4 py-3">
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold text-white lead" style="font-size: 1.1rem;">@item.Title</span>
                                        <small class="text-white-50 text-truncate" style="max-width: 250px;">@item.Description</small>
                                    </div>
                                </td>

                                <td>
                                    @if (item.Priority == 1)
                                    {
                                        <span class="badge bg-danger text-dark fw-bold"><i class="bi bi-exclamation-triangle-fill me-1"></i>CRITIC</span>
                                    }
                                    else if (item.Priority == 2)
                                    {

                                        <span class="badge bg-warning text-dark fw-bold">MEDIU</span>
                                    }
                                    else
                                    {

                                        <span class="badge bg-info text-dark fw-bold">NORMAL</span>
                                    }
                                </td>

                                <td>
                                    @if (!item.IsActive)
                                    {
                                        <span class="badge bg-success border border-success p-2 font-monospace">
                                            <i class="bi bi-check-all me-1"></i> FINALIZAT
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-primary border border-primary p-2 font-monospace">
                                            <i class="bi bi-activity me-1"></i> ACTIV
                                        </span>
                                    }
                                </td>

                                <td>
                                    <div class="d-flex flex-column gap-1">
                                        @if (item.Assignments != null && item.Assignments.Any())
                                        {
                                            foreach (var assign in item.Assignments)
                                            {
                                                string statusUser = assign.Status == 2 ? "text-success" : (assign.Status == 1 ? "text-warning" : "text-muted");
                                                string iconUser = assign.Status == 2 ? "bi-check-circle-fill" : (assign.Status == 1 ? "bi-hourglass-split" : "bi-circle");

                                                <small class="font-monospace @statusUser">
                                                    <i class="bi @iconUser me-1"></i> @(assign.User?.FullName ?? "Unknown")
                                                </small>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-white-50 small">Neasignat</span>
                                        }
                                    </div>
                                </td>

                                <td>
                                    @if (!item.IsActive)
                                    {
                                        <span class="text-success fw-bold font-monospace small">
                                            <i class="bi bi-flag-fill"></i> TASK ÎNCHIS
                                        </span>
                                    }
                                    else if (item.DueDate.HasValue)
                                    {
                                        if (isOverdue)
                                        {
                                            <span class="text-danger fw-bold font-monospace">
                                                <i class="bi bi-alarm-fill me-1"></i> EXPIRAT
                                            </span>
                                            <div class="small text-danger">@item.DueDate.Value.ToString("dd.MM HH:mm")</div>
                                        }
                                        else
                                        {
                                            var timeSpan = item.DueDate.Value - DateTime.Now;
                                            string timerColor = timeSpan.TotalHours < 24 ? "text-warning" : "text-info";

                                            <span class="@timerColor fw-bold font-monospace">
                                                <i class="bi bi-stopwatch me-1"></i>
                                                @if (timeSpan.TotalDays >= 1)
                                                {
                                                    <span>@((int)timeSpan.TotalDays)z </span>
                                                }
                                                @timeSpan.ToString(@"hh\:mm") rămas
                                            </span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted small">--</span>
                                    }
                                </td>

                                <td class="text-end pe-4">
                                    <div class="btn-group">
                                        @if (item.IsActive)
                                        {
                                            @if (item.Assignments.Any())
                                            {
                                                var firstAssign = item.Assignments.First();
                                                <a asp-action="Reassign" asp-route-id="@firstAssign.TaskAssignmentId"
                                                   class="btn btn-sm btn-outline-warning" title="Schimbă Userul">
                                                    <i class="bi bi-person-gear"></i>
                                                </a>
                                            }

                                            <form asp-action="Delete" asp-route-id="@item.TaskId" method="post" style="display:inline;"
                                                  onsubmit="return confirm('Sigur ștergi acest task?');">
                                                <button type="submit" class="btn btn-sm btn-outline-danger ms-1" title="Șterge">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        }
                                        else
                                        {
                                            <form asp-action="Delete" asp-route-id="@item.TaskId" method="post" style="display:inline;"
                                                  onsubmit="return confirm('Task-ul este finalizat. Îl arhivezi (ștergi)?');">
                                                <button type="submit" class="btn btn-sm btn-secondary ms-1" title="Arhivează">
                                                    <i class="bi bi-archive-fill"></i>
                                                </button>
                                            </form>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>