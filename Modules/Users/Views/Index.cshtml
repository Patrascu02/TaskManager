@model IEnumerable<TaskManager.Modules.Users.Models.UserViewModel>

@{
    ViewData["Title"] = "GESTIUNE UTILIZATORI";
    Layout = "~/Modules/Views/Shared/_Layout.cshtml";
}

<div class="fade-in pt-4">

    <header class="hud-header-panel mb-4 mt-4">
        <div>
            <h2 class="hud-welcome">UTILIZATORI</h2>
            <small>GESTIONEAZĂ ECHIPA ȘI ROLURILE</small>
        </div>
        <a asp-action="Create" class="btn-tech text-decoration-none">
            <i class="bi bi-person-plus-fill me-2"></i> ADAUGĂ USER
        </a>
    </header>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success border border-success bg-opacity-10 bg-success text-white mb-4 shadow-sm" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @TempData["Success"]
        </div>
    }

    <div class="cyber-table-card">

        <div class="p-3 border-bottom border-secondary" style="background: rgba(0,0,0,0.2);">
            <div class="input-group" style="max-width: 350px;">
                <span class="input-group-text border-secondary bg-dark text-info">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="searchUser" class="form-control bg-dark text-light border-secondary font-monospace" placeholder="CAUTĂ UTILIZATOR...">
            </div>
        </div>

        <div class="table-responsive">
            <table class="cyber-table align-middle mb-0">
                <thead>
                    <tr>
                        <th class="ps-4">UTILIZATOR</th>
                        <th>EMAIL</th>
                        <th>ROL</th>
                        <th class="pe-4 text-end">ACȚIUNI</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    @foreach (var item in Model)
                    {
                        var displayName = (!string.IsNullOrEmpty(item.FirstName) || !string.IsNullOrEmpty(item.LastName))
                        ? $"{item.FirstName} {item.LastName}"
                        : item.Email;

                        var initials = "";
                        if (!string.IsNullOrEmpty(item.FirstName) && !string.IsNullOrEmpty(item.LastName))
                        {
                            initials = item.FirstName.Substring(0, 1).ToUpper() + item.LastName.Substring(0, 1).ToUpper();
                        }
                        else if (!string.IsNullOrEmpty(item.Email))
                        {
                            initials = item.Email.Substring(0, 1).ToUpper();
                        }

                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="d-flex align-items-center justify-content-center me-3 text-info font-monospace fw-bold"
                                         style="width: 40px; height: 40px; background: rgba(6, 182, 212, 0.1); border: 1px solid var(--hud-cyan); border-radius: 4px;">
                                        @initials
                                    </div>
                                    <div>
                                        <div class="fw-bold text-white">@displayName</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-white-50 small font-monospace">@item.Email</td>
                            <td>
                                @if (item.Role == "Admin")
                                {
                                    <span class="badge bg-danger bg-opacity-25 text-danger border border-danger">
                                        <i class="fas fa-user-shield me-1"></i> ADMIN
                                    </span>
                                }
                                else if (item.Role == "Manager")
                                {
                                    <span class="badge bg-warning bg-opacity-25 text-warning border border-warning">
                                        <i class="fas fa-user-tie me-1"></i> MANAGER
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-info bg-opacity-25 text-info border border-info">
                                        <i class="fas fa-user me-1"></i> USER
                                    </span>
                                }
                            </td>
                            <td class="pe-4 text-end">
                                <div class="btn-group">
                                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-outline-info me-2 rounded-0" title="Editează">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger rounded-0"
                                            onclick="confirmDelete('@item.Id', '@item.Email')"
                                            title="Șterge">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!Model.Any())
        {
            <div class="text-center py-5">
                <div class="text-secondary mb-3"><i class="fas fa-users-slash fa-3x"></i></div>
                <h6 class="text-secondary font-monospace">NU EXISTĂ UTILIZATORI ÎNREGISTRAȚI.</h6>
            </div>
        }
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #1e293b; border: 1px solid var(--hud-border); color: #e2e8f0;">
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <div class="d-inline-flex align-items-center justify-content-center"
                         style="width: 80px; height: 80px; background: rgba(244, 63, 94, 0.1); border-radius: 50%; border: 1px solid #f43f5e;">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger"></i>
                    </div>
                </div>

                <h4 class="fw-bold text-white mb-2 font-monospace">EȘTI SIGUR?</h4>
                <p class="text-white-50 mb-4">
                    Ești pe cale să ștergi utilizatorul <strong id="deleteUserName" class="text-info"></strong>.<br>
                    Această acțiune este ireversibilă.
                </p>

                <div class="d-flex justify-content-center gap-2">
                    <button type="button" class="btn btn-outline-light px-4 font-monospace" data-bs-dismiss="modal">
                        ANULEAZĂ
                    </button>
                    <form id="deleteForm" method="post">
                        <button type="submit" class="btn btn-danger px-4 fw-bold font-monospace">
                            DA, ȘTERGE
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Căutare
        document.getElementById('searchUser').addEventListener('keyup', function() {
            var value = this.value.toLowerCase();
            var rows = document.querySelectorAll("#userTableBody tr");
            rows.forEach(function(row) {
                var text = row.innerText.toLowerCase();
                row.style.display = text.indexOf(value) > -1 ? "" : "none";
            });
        });

        // SOLUȚIE PENTRU BLOCARE ECRAN:
        // Mutăm modalul în <body> imediat ce se încarcă scriptul.
        // Astfel evităm orice problemă de z-index sau CSS overflow din containerele părinte.
        var deleteModalElement = document.getElementById('deleteModal');
        if (deleteModalElement) {
            document.body.appendChild(deleteModalElement);
        }

        function confirmDelete(userId, userEmail) {
            document.getElementById('deleteUserName').textContent = userEmail;
            document.getElementById('deleteForm').action = '/Users/Delete/' + userId;

            // Folosim metoda sigură getOrCreateInstance
            var myModal = bootstrap.Modal.getOrCreateInstance(deleteModalElement);
            myModal.show();
        }
    </script>
}