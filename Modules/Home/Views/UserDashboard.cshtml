@model IEnumerable<TaskManager.Modules.Tasks.Models.TaskAssignment>

@{
    Layout = "_Layout";
    ViewData["Title"] = "Profilul Meu";
}

<div class="container py-5">

    <div class="row mb-5 fade-in-up">
        <div class="col-12">
            <div class="card border-0 shadow-lg overflow-hidden position-relative bg-admin-primary text-white">
                <i class="bi bi-controller position-absolute opacity-25" style="font-size: 10rem; right: -20px; top: -30px; transform: rotate(15deg);"></i>

                <div class="card-body p-5 position-relative z-1">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                        <div class="text-center text-md-start mb-4 mb-md-0">
                            <h6 class="text-uppercase text-white-50 fw-bold ls-1 mb-2">Bine ai revenit,</h6>
                            <h1 class="display-4 fw-bold mb-0 text-shadow">@User.Identity.Name!</h1>
                            <p class="mb-0 mt-2 opacity-75"><i class="bi bi-check2-circle me-1"></i> Ai <strong>@Model.Count()</strong> sarcini active.</p>
                        </div>

                        <div class="d-flex align-items-center gap-4 bg-white bg-opacity-10 p-4 rounded-4 backdrop-blur shadow-sm border border-white border-opacity-25">
                            <div class="text-center px-2">
                                <div class="display-5 fw-bold text-warning mb-0">@(ViewBag.CurrentLevel ?? 1)</div>
                                <small class="text-uppercase fw-bold small opacity-75">Level</small>
                            </div>
                            <div style="width: 1px; height: 50px; background: rgba(255,255,255,0.3);"></div>
                            <div class="text-center px-2">
                                <div class="display-5 fw-bold text-white mb-0">@(ViewBag.CurrentXp ?? 0)</div>
                                <small class="text-uppercase fw-bold small opacity-75">Total XP</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5 fade-in-up" style="animation-delay: 0.1s;">
        <div class="col-12">
            <h4 class="mb-4 fw-bold text-primary"><i class="bi bi-award-fill me-2"></i>Colectia Mea</h4>

            <div class="card border-0 shadow-sm p-4">
                @if (ViewBag.MyBadges != null && ((IEnumerable<dynamic>)ViewBag.MyBadges).Any())
                {
                    <div class="d-flex flex-wrap gap-4 justify-content-center justify-content-md-start">
                        @foreach (var userBadge in ViewBag.MyBadges)
                        {
                            <div class="text-center hover-lift p-3 rounded-4 bg-light border border-light"
                                 style="min-width: 120px; transition: 0.3s;"
                                 title="@userBadge.Badge.Description">
                                <div class="bg-white rounded-circle shadow-sm p-3 d-inline-block mb-2">
                                    <i class="bi bi-star-fill fs-1 text-warning"></i>
                                </div>
                                <h6 class="fw-bold text-dark mb-1">@userBadge.Badge.Name</h6>
                                <small class="text-muted" style="font-size: 0.7rem;">@userBadge.AwardedAt.ToString("dd MMM")</small>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-trophy fs-1 opacity-25 mb-2 d-block"></i>
                        <p class="mb-0">Încă nu ai insigne. Finalizează sarcini pentru a le debloca!</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <h4 class="mb-4 fw-bold text-primary fade-in-up" style="animation-delay: 0.2s;">
        <i class="bi bi-list-task me-2"></i>Task-uri Active
    </h4>

    @if (!Model.Any())
    {
        <div class="alert alert-success shadow-sm fade-in-up d-flex align-items-center p-4 rounded-4 border-0" style="background: rgba(209, 250, 229, 0.8);">
            <i class="bi bi-cup-hot-fill fs-2 me-3 text-success"></i>
            <div>
                <h5 class="fw-bold text-success mb-1">Ești liber!</h5>
                <p class="mb-0 text-success opacity-75">Nu ai nicio sarcină activă momentan. Relaxează-te! ☕</p>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var assignment in Model)
            {
                // LOGICĂ C# (Păstrată intactă)
                var isOverdue = assignment.Task.DueDate.HasValue && assignment.Task.DueDate.Value < DateTime.Now;
                string timerClass = "bg-success";
                string timerText = "Fără termen";
                string borderClass = "border-success"; // Default Low Priority (3)

                if (assignment.Task.Priority == 1) { borderClass = "border-danger"; } // High
                else if (assignment.Task.Priority == 2) { borderClass = "border-warning"; } // Medium

                if (assignment.Task.DueDate.HasValue)
                {
                    var timeRemaining = assignment.Task.DueDate.Value - DateTime.Now;
                    if (isOverdue)
                    {
                        timerClass = "bg-danger";
                        timerText = "Expirat (-50% XP)";
                        borderClass = "border-danger";
                    }
                    else if (timeRemaining.TotalDays < 1)
                    {
                        timerClass = "bg-warning text-dark";
                        timerText = $"Urgent: {timeRemaining.Hours}h {timeRemaining.Minutes}m";
                    }
                    else
                    {
                        timerClass = "bg-success";
                        timerText = $"{timeRemaining.Days}z {timeRemaining.Hours}h rămase";
                    }
                }

                <div class="col-md-6 col-lg-4 fade-in-up" style="animation-delay: 0.3s;">
                    <div class="card h-100 shadow-sm hover-lift border-0 border-start border-5 @borderClass position-relative overflow-hidden">

                        @if (isOverdue)
                        {
                            <div class="position-absolute top-0 start-0 w-100 h-100 bg-danger opacity-10 pe-none"></div>
                        }

                        <div class="card-body d-flex flex-column p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="badge @timerClass rounded-pill shadow-sm px-3 py-2">
                                    <i class="bi bi-clock me-1"></i> @timerText
                                </span>
                                @if (assignment.Status == 0)
                                {
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 rounded-pill">Nou</span>
                                }
                                else
                                {
                                    <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25 rounded-pill">În Lucru</span>
                                }
                            </div>

                            <h5 class="card-title fw-bold text-dark mb-2">@assignment.Task.Title</h5>
                            <p class="card-text text-muted small flex-grow-1 mb-4" style="line-height: 1.6;">
                                @(assignment.Task.Description?.Length > 100 ? assignment.Task.Description.Substring(0, 100) + "..." : assignment.Task.Description)
                            </p>

                            <div class="d-flex align-items-center justify-content-between border-top pt-3 mt-auto border-light">
                                <small class="text-muted fw-bold">
                                    <i class="bi bi-calendar-event me-1 text-primary"></i>
                                    @(assignment.Task.DueDate.HasValue? assignment.Task.DueDate.Value.ToString("dd MMM HH:mm") : "N/A")
                                </small>
                            </div>

                            <div class="d-grid mt-3">
                                @if (assignment.Status == 0)
                                {
                                    <a asp-controller="Tasks" asp-action="VoteDifficulty" asp-route-id="@assignment.TaskAssignmentId" class="btn btn-outline-primary rounded-pill fw-bold">
                                        <i class="bi bi-bar-chart-fill me-2"></i>Votează Dificultatea
                                    </a>
                                }
                                else
                                {
                                    <a asp-controller="Tasks" asp-action="CompleteTask" asp-route-id="@assignment.TaskAssignmentId" class="btn btn-success text-white rounded-pill fw-bold shadow-sm">
                                        <i class="bi bi-check-circle-fill me-2"></i>Finalizează
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .backdrop-blur {
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
    }

    .ls-1 {
        letter-spacing: 1px;
    }

    .hover-lift {
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
    }

        .hover-lift:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1) !important;
        }
</style>