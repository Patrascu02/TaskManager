@using TaskManager.Modules.Tasks.Models
@using TaskManager.Modules.Users.Models
@using TaskManager.Modules.Gamification.Models
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@model IEnumerable<TaskAssignment>

@{
    Layout = "_Layout";
    ViewData["Title"] = "Dashboard";

    // Date Utilizator
    var currentUser = await UserManager.GetUserAsync(User);
    string displayName = currentUser?.FullName;
    if (string.IsNullOrEmpty(displayName)) displayName = currentUser?.UserName?.Split('@')[0] ?? "Angajat";

    string userInitials = "U";
    if (!string.IsNullOrEmpty(displayName))
    {
        var parts = displayName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        userInitials = parts.Length >= 2 ? $"{parts[0][0]}{parts[1][0]}".ToUpper() : parts[0].Substring(0, 1).ToUpper();
    }

    // Statistici
    int currentLevel = (ViewBag.CurrentLevel as int?) ?? 1;
    int currentXp = (ViewBag.CurrentXp as int?) ?? 0;
    int xpProgress = currentXp % 100;

    // Insigne
    var myBadges = ViewBag.MyBadges as IEnumerable<UserBadge>;
    if (myBadges == null) { myBadges = new List<UserBadge>(); }

    var tasksNew = Model.Where(t => t.Status == 0).ToList();
    var tasksInProgress = Model.Where(t => t.Status == 1).ToList();
}

<div class="dashboard-wrapper fade-in">

    <aside class="dashboard-sidebar">
        <div class="profile-section">
            <div class="avatar-container">
                <div class="avatar-circle">@userInitials</div>
            </div>
            <h5 class="profile-name text-truncate w-100" title="@displayName">@displayName</h5>
            <p class="profile-role">Angajat</p>
        </div>

        <div class="stats-card mt-4">
            <div class="d-flex justify-content-between align-items-end mb-2">
                <span class="text-uppercase fw-bold text-white-50 small">Level @currentLevel</span>
                <span class="fw-bold text-warning">@currentXp XP</span>
            </div>
            <div class="xp-track">
                <div class="xp-fill" style="width: @xpProgress%;"></div>
            </div>
            <div class="text-end mt-1">
                <small class="text-white-50" style="font-size: 0.65rem;">Next: @(100 - xpProgress) XP</small>
            </div>
        </div>

        <div class="quick-stats-grid mt-4">
            <div class="q-stat">
                <span class="h4 fw-bold mb-0 d-block">@Model.Count()</span>
                <small>Sarcini</small>
            </div>
            <div class="q-stat">
                <span class="h4 fw-bold mb-0 d-block">@myBadges.Count()</span>
                <small>Insigne</small>
            </div>
        </div>

        <div class="badges-section mt-5">
            <h6 class="sidebar-label">
                <i class="bi bi-award-fill me-2"></i>Colecția Mea
            </h6>

            @if (myBadges.Any())
            {
                <div class="badges-grid">
                    @foreach (var ub in myBadges)
                    {
                        var badgeName = ub.Badge?.Name ?? "Insignă";
                        var iconClass = ub.Badge?.Icon ?? "bi-star-fill";

                        <div class="badge-box" data-bs-toggle="tooltip" title="@badgeName">
                            <i class="bi @iconClass text-warning fs-5"></i>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center p-3 rounded" style="background: rgba(255,255,255,0.1);">
                    <i class="bi bi-lock-fill fs-3 text-white-50 mb-2 d-block"></i>
                    <p class="text-white-50 small mb-0">Nicio insignă.</p>
                </div>
            }
        </div>
    </aside>

    <main class="dashboard-main">
        <header class="main-header mb-5">
            <div>
                <h2 class="fw-bold text-dark mb-1">Salut, @displayName! 👋</h2>
                <p class="text-muted mb-0">Spor la treabă astăzi.</p>
            </div>
            <div class="header-date d-none d-md-block">
                <i class="bi bi-calendar-day me-2 text-primary"></i>
                @DateTime.Now.ToString("dd MMMM yyyy")
            </div>
        </header>

        <div class="row g-4">

            <div class="col-lg-6">
                <div class="h-100">

                    <div class="column-header-glass header-todo">
                        <div class="d-flex align-items-center">
                            <div class="icon-box shadow-sm">
                                <i class="bi bi-inbox-fill"></i>
                            </div>
                            <div>
                                <h6 class="column-title">De Făcut</h6>
                                <small class="text-muted" style="font-size: 0.75rem;">Sarcini noi</small>
                            </div>
                        </div>
                        <span class="column-count">@tasksNew.Count</span>
                    </div>

                    <div>
                        @if (!tasksNew.Any())
                        {
                            <div class="empty-state"><i class="bi bi-emoji-smile fs-1 mb-2 text-muted opacity-50"></i><p>Nu ai sarcini noi.</p></div>
                        }
                        @foreach (var task in tasksNew)
                        {
                            @RenderTaskCard(task)
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="h-100">

                    <div class="column-header-glass header-progress">
                        <div class="d-flex align-items-center">
                            <div class="icon-box shadow-sm">
                                <i class="bi bi-lightning-charge-fill"></i>
                            </div>
                            <div>
                                <h6 class="column-title">În Lucru</h6>
                                <small class="text-muted" style="font-size: 0.75rem;">Progres activ</small>
                            </div>
                        </div>
                        <span class="column-count">@tasksInProgress.Count</span>
                    </div>

                    <div>
                        @if (!tasksInProgress.Any())
                        {
                            <div class="empty-state"><i class="bi bi-cup-hot fs-1 mb-2 text-muted opacity-50"></i><p>Nimic în lucru.</p></div>
                        }
                        @foreach (var task in tasksInProgress)
                        {
                            @RenderTaskCard(task)
                        }
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

@{
    Microsoft.AspNetCore.Html.IHtmlContent RenderTaskCard(TaskAssignment assignment)
    {
        int pVal = assignment.Task.Priority;
        string priorityClass = pVal == 1 ? "priority-high" : (pVal == 2 ? "priority-medium" : "priority-low");
        string priorityLabel = pVal == 1 ? "Ridicat" : (pVal == 2 ? "Mediu" : "Scăzut");

        bool isOverdue = assignment.Task.DueDate.HasValue && assignment.Task.DueDate.Value < DateTime.Now;
        string dateText = assignment.Task.DueDate.HasValue ? assignment.Task.DueDate.Value.ToString("dd MMM") : "Fără termen";
        string dateColor = isOverdue ? "text-danger fw-bold" : "text-muted";
        string dateIcon = isOverdue ? "bi-exclamation-circle-fill" : "bi-calendar2-event";

        <div class="task-card @priorityClass">
            <div class="task-indicator"></div>

            <div class="d-flex justify-content-between align-items-start mb-2 ps-3">
                <span class="priority-badge">@priorityLabel</span>
                @if (isOverdue)
                {
                    <span class="badge bg-danger rounded-pill shadow-sm" style="font-size: 0.65rem;">
                        <i class="bi bi-clock-history me-1"></i> Expirat
                    </span>
                }
            </div>

            <h5 class="task-title">@assignment.Task.Title</h5>

            <p class="task-desc text-truncate-2">
                @(assignment.Task.Description?.Length > 90 ? assignment.Task.Description.Substring(0, 90) + "..." : assignment.Task.Description)
            </p>

            <div class="task-footer">
                <span class="@dateColor small fw-bold">
                    <i class="bi @dateIcon me-1"></i> @dateText
                </span>

                @if (assignment.Status == 0)
                {
                    <a href="/Tasks/VoteDifficulty/@assignment.TaskAssignmentId" class="btn-action-task btn-vote text-decoration-none">
                        Votează
                    </a>
                }
                else
                {
                    <a href="/Tasks/CompleteTask/@assignment.TaskAssignmentId" class="btn-action-task btn-complete text-decoration-none">
                        <i class="bi bi-check-lg me-1"></i>Gata
                    </a>
                }
            </div>
        </div>
        return null;
    }
}